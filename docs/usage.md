# 使用指南

## 目录

- [Skill 工作原理](#skill-工作原理)
- [完整工作流程](#完整工作流程)
- [日志脚本详解](#日志脚本详解)
- [常见使用场景](#常见使用场景)
- [最佳实践](#最佳实践)

---

## Skill 工作原理

`code-partner` 是一个 Claude Code Skill，它会在每次代码任务执行前自动触发，进行技术益害评估。

### 触发条件

以下情况会自动触发 skill：
- 新功能开发
- 代码重构或优化
- 架构调整
- 引入第三方依赖
- 性能相关变更

### 评估流程

```
1. 识别任务类型（需求/优化/Bug修复）
2. 进行益处检查
3. 进行风险评估
4. 判定风险等级（🟢低 / 🟡中 / 🔴高）
5. 根据等级决定响应策略
```

---

## 完整工作流程

### 场景 1：低风险变更（🟢）

```
用户：优化这个函数的性能

Claude：
✅ 技术益害评估：
  益处：提升查询效率 50%
  风险：🟢 低风险 - 局部优化，易回滚

→ 直接执行变更
→ 记录优化日志
→ 更新测试
→ 验证功能
```

### 场景 2：中风险变更（🟡）

```
用户：引入 Redis 缓存

Claude：
⚠️ 技术益害评估：
  益处：显著降低数据库负载
  风险：🟡 中风险
    - 增加系统复杂度
    - 需要额外维护缓存服务
    - 可能出现数据不一致

💡 建议：
  1. 先评估是否有更简单的方案（如内存缓存）
  2. 确认是否真的需要分布式缓存
  3. 考虑使用方案 2 减少依赖

→ 等待用户确认
→ 执行（或调整方案）
→ 记录优化日志
...
```

### 场景 3：高风险变更（🔴）

```
用户：把所有单例改成全局变量

Claude：
🚨 技术益害评估：
  风险：🔴 高风险
    - 破坏单例模式的线程安全性
    - 可能导致状态不一致
    - 影响整个系统稳定性

❌ 强烈不建议此方案

✅ 推荐替代方案：
  1. 保持单例模式，通过依赖注入解决
  2. 使用上下文管理器控制生命周期
  3. 考虑使用工厂模式

请选择替代方案或提供更多背景信息...
```

---

## 日志脚本详解

### 基本用法

```bash
python skills/code-partner/scripts/log_change.py [选项]
```

### 参数说明

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--type` | ❌ | 变更类型 | `--type "优化"` |
| `--purpose` | ✅ | 变更目的 | `--purpose "解决N+1查询问题"` |
| `--modules` | ❌ | 涉及模块 | `--modules "user, auth"` |
| `--changes` | ❌ | 具体修改 | `--changes "添加索引"` |
| `--method` | ❌ | 实施方法 | `--method "数据库优化"` |
| `--metrics` | ❌ | 成功指标 | `--metrics "响应时间 < 100ms"` |
| `--test` | ❌ | 测试方案 | `--test "单元测试 + 压测"` |
| `--risk` | ❌ | 风险评估 | `--risk "中风险"` |
| `--impact` | ❌ | 相关影响 | `--impact "需同步优化其他模块"` |
| `--todos` | ❌ | 待办事项 | `--todos "- 更新文档"` |
| `--owner` | ❌ | 负责人 | `--owner "Claude"` |

### 完整示例

```bash
python skills/code-partner/scripts/log_change.py \
  --type "优化" \
  --purpose "优化用户查询接口性能，解决N+1问题" \
  --modules "user_service, database_layer" \
  --changes "使用 selectinload() 预加载关联数据" \
  --method "SQLAlchemy ORM 批量加载" \
  --metrics "- API响应时间从 800ms 降至 150ms 以下
- 数据库查询次数从 N+1 降至 2 次" \
  --test "单元测试: tests/test_user_service.py
性能测试: 使用 1000 用户数据集基准测试" \
  --risk "中风险 - 预加载可能增加内存占用，已添加监控" \
  --impact "其他列表查询可参考此方案同步优化" \
  --todos "- 审查所有循环查询代码
- 建立查询性能监控告警" \
  --owner "Claude"
```

### 输出示例

```
✅ 创建新日志文件: project_logs/optimization/2026-02-07.md

✅ 变更已记录至优化日志 v1.2.3
📄 日志文件: project_logs/optimization/2026-02-07.md

--- 日志内容预览 ---
### 【优化日志条目】

**变更类型**：优化
**时间戳**：2026-02-07 14:30:00
**版本号**：v1.2.3
**负责人**：Claude

#### 变更目的
优化用户查询接口性能，解决N+1问题

...
```

---

## 常见使用场景

### 1. 新功能开发

**场景**：添加用户认证功能

```bash
python skills/code-partner/scripts/log_change.py \
  --type "需求" \
  --purpose "实现 JWT 用户认证" \
  --modules "auth, middleware" \
  --changes "添加 JWT 签发和验证逻辑" \
  --method "使用 PyJWT 库实现" \
  --metrics "- 成功签发 token
- 正确验证过期 token" \
  --test "单元测试 + 集成测试" \
  --risk "中风险 - 需保证密钥安全" \
  --impact "需要更新 API 文档" \
  --todos "- 配置密钥轮换策略
- 添加 refresh token 机制"
```

### 2. 性能优化

**场景**：优化慢查询

```bash
python skills/code-partner/scripts/log_change.py \
  --type "优化" \
  --purpose "优化搜索接口性能" \
  --modules "search_service" \
  --changes "添加复合索引，优化查询条件" \
  --method "数据库索引优化" \
  --metrics "查询时间 < 200ms" \
  --test "使用生产数据集压测" \
  --risk "低风险 - 索引会增加写入开销" \
  --impact "需要定期监控索引大小"
```

### 3. Bug 修复

**场景**：修复并发问题

```bash
python skills/code-partner/scripts/log_change.py \
  --type "Bug修复" \
  --purpose "修复并发写入数据竞争" \
  --modules "data_writer" \
  --changes "添加线程锁保护共享状态" \
  --method "使用 threading.Lock()" \
  --metrics "- 无数据丢失
- 无死锁发生" \
  --test "并发压力测试" \
  --risk "中风险 - 锁可能影响性能" \
  --impact "需监控锁等待时间"
```

---

## 最佳实践

### 1. 及时记录

- **每次变更后立即记录**，不要拖延
- 一次性记录多个相关变更时，使用子条目

### 2. 详略得当

- **高风险变更**：详细记录所有字段
- **低风险变更**：可简化非关键字段

### 3. 版本管理

- 版本号自动递增，无需手动管理
- 重大变更更新主版本号

### 4. 定期回顾

- 每周回顾优化日志
- 识别常见问题和模式
- 持续改进开发流程

### 5. 团队协作

- 在 `.gitignore` 中排除 `project_logs/`（如果是敏感信息）
- 或者将日志纳入版本控制（如果适合团队分享）
- 统一使用日志脚本，保持格式一致

---

## 常见问题

### Q1: 日志文件太大会影响性能吗？

**A**: 不会。日志按天分割，每天一个文件，单个文件通常只有几十 KB。

### Q2: 可以手动编辑日志文件吗？

**A**: 可以，但不建议。使用脚本可以保证格式一致，避免遗漏重要信息。

### Q3: 版本号重置怎么办？

**A**: 删除 `project_logs/optimization/.version` 文件，版本号会从 v1.0.1 重新开始。

### Q4: 如何迁移旧日志？

**A**: 将旧的日志文件复制到 `project_logs/optimization/` 目录，文件名格式为 `YYYY-MM-DD.md`。
